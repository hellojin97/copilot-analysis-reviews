name: Send Dashboard Email Report

on:
  workflow_dispatch:
    inputs:
      recipient_email:
        description: 'ìˆ˜ì‹ ì ì´ë©”ì¼ ì£¼ì†Œ (ì„ íƒì‚¬í•­, ê¸°ë³¸ê°’: SENDER_EMAILê³¼ ë™ì¼)'
        required: false
        type: string

jobs:
  send-email-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
      
      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: í•œê¸€ í°íŠ¸ ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-nanum fonts-nanum-coding fonts-nanum-extra
          fc-cache -fv
          echo "âœ“ í•œê¸€ í°íŠ¸ ì„¤ì¹˜ ì™„ë£Œ"
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install kiwipiepy scikit-learn requests matplotlib seaborn wordcloud
      
      - name: ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸
        run: |
          if [ ! -f "data/reviews.db" ]; then
            echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. CSV íŒŒì¼ì„ ë¡œë“œí•©ë‹ˆë‹¤..."
            python scripts/load_csv_to_db_simple.py
          else
            echo "âœ“ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ì¡´ì¬"
          fi
      
      - name: ìƒí’ˆ í”„ë¡œí•„ ìºì‹œ ìƒì„±
        run: |
          if [ ! -f "cache/product_profiles.pkl" ]; then
            echo "ìƒí’ˆ í”„ë¡œí•„ ìºì‹œ ìƒì„± ì¤‘..."
            python -m src.recommendation_system
          else
            echo "âœ“ ìºì‹œ íŒŒì¼ ì¡´ì¬"
          fi
      
      - name: ì´ë©”ì¼ ë¦¬í¬íŠ¸ ì „ì†¡
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
          RECIPIENT_EMAIL: ${{ inputs.recipient_email || secrets.SENDER_EMAIL }}
        run: |
          echo "ğŸ“§ ì´ë©”ì¼ ì „ì†¡ ì‹œì‘"
          echo "ì†¡ì‹ ì: $SENDER_EMAIL"
          echo "ìˆ˜ì‹ ì: $RECIPIENT_EMAIL"
          python -m emailer.send_email_report
      
      - name: ì „ì†¡ ì™„ë£Œ ì•Œë¦¼
        if: success()
        run: |
          echo "âœ… ì´ë©”ì¼ ë¦¬í¬íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ìˆ˜ì‹ ì: ${{ inputs.recipient_email || secrets.SENDER_EMAIL }}"
      
      - name: ì „ì†¡ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          echo "GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
